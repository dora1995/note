## 1、概述

WebRtc（web Real-Time Communication)，网页即时通讯，于2011年6月1日开源，通过简单的API为浏览器和移动应用程序提供**实时通信**功能

WebRtc是一个由Google发起的实时通信解决方案，其中包含**视频/音频采集、编解码、数据传输、音视频展示**等

无论终端运行环境是浏览器、桌面应用、移动设备、Iot设备，只要IP链接可到达且符合WebRtc规范便可互通；特点有：跨平台、实时传播、强大的音视频处理能力、免插件、免费、强大的打洞能力（STUN、ICE、TURN、RTP-over-TCP的关键NAT和防火墙穿透，并支持代理）、主流支持

应用场景：音视频会议、在线教育、照相机、音乐播放器、共享桌面、录制、即时通信工具、P2P网络加速、文件传输、实时人脸识别、

## 2、通话原理

两个不同网络环境的浏览器，如何实现点对点的实时音视频对话，即WebRtc的最典型场景：一对一音视频通话

假设通话的双方为Pa与Pb，要建立起通话，主要步骤有：
1. 媒体协商。Pa与Pb通过**信令服务器进行媒体协商**，如双方使用的**音视频编码格式**，双方交换的媒体数据由SDP（Session Description Protocol，绘画描述协议）描述
2. 网络协商。Pa与Pb通过STUN服务器获取各自的网络信息，如ip和端口，然后通过信令服务器转发，互相交换各种网络信息；**即完成P2P打洞成功建立连接**，该过程涉及NAT及ICE协议
3. 建立连接。Pa与Pb如果没有建立起直连，则通过TURN中转服务器转发音视频数据，最终完成音视频通话



### 2.1、媒体协商
两个客户端想要建立连接，一般来说需要有一个双方都能访问的服务器来帮助他们**交换连接所需要的信息**

有了中间人（服务器）后，两个客户端首先要交换的数据是**SDP**，这里面描述要建立怎样的连接；从双方的能力描述中取交集，取能保证双方都能正确编解码的编码格式

SDP：**Pa => 通过API制定自己要传输什么数据，以及自己希望接收什么数据 => SessionDescript => 公共服务器 => Pb**，由哪方主动都可以；SDP是一个描述多媒体连接内容的协议，例如分辨率、格式、编码、加密算法等，严格来说是一种数据格式

信令服务器：用来交换双方的SDP信息，一般通过创建socket连接进行交互，使用其他方式也可以，只要达到交换数据的目的


### 2.2、网络协商
SDP中有对于IP和端口的描述，但WebRtc并没有使用它；通信双方彼此要了解对方的网络情况，需要做以下两个处理：
- 获取外网IP地址映射
- 通过信令服务器交换“网络信息”

理想的网络情况是每个浏览器所在的计算机IP都是公网IP，然后能实现直接点对点连接；然而实际情况是我们的计算机都是在**某个局域网中并且有防火墙**，需要进行**网络地址转换**（Network Address Translation，NAT）

在解决WebRtc使用过程中的上述问题，会用到NAT、STUN和TURN等概念：
1. NAT：为了解决IPv4下的IP地址匮乏而出现的一种技术，例如路由器的地址分配
NAT技术会保护内网地址的安全性，这样也会导致在采用P2P中的连接方式会被阻止，于是就要**采用NAT穿透技术**：借助一个公网IP服务器，Pa与Pb都往公网服务器IP/PORT发包，这样公网服务器就可以获知Pa和Pb的IP/PORT（由于Pa与Pb主动给公网IP服务发包，所以公网服务器可以穿透NAT-A与NAT-Bb并发包），同理公共服务器将Pb的IP/PORT转给Pa，Pa的IP/PORT转给Pb，这样Pa和Pb下次互相发送信息时，就不会被NAT拦截了

WebRtc的防火墙穿透技术就是基于上述思路实现的，采用了ICE框架来保证RTCPeerConnection能实现NAT穿透

2. ICE（Interactive Connectiivity Establishment，互动式连接建立），是一种框架，是各种NAT穿透技术（如STUN、TURN等）可以统一，能保证穿透各种防火墙
3. STUN
简单的UDP穿透NAT（Simple Traversal of UDP Through NAT），这项技术允许位于NAT后的客户端找到自己的公网IP地址，以及查处自己位于哪种类型的NAT和NAT所绑定的端口，然后这些信息可用于将两个同时处在NAT路由器后的主机之间建立UDP通信

即使通过STUN获取到公网IP位址，仍可能建立不成功：因为不同的NAT类型处理传入的UDP分组的方式不同，有四种
- 完全圆锥型NAT
- 受限圆锥型NAT
- 端口受限圆锥型NAT
- 对称型NAT（这个不能被成功处理，需要用到TURN技术）

4. TRUN
指使用中继穿透NAT（Traversal Using Relays around NAT），时STUN的一个拓展，主要是加了中继功能；通过TURN服务器请求公网IP地址作为中继地址，将媒体数据由TRUN服务器中转

5. 信令服务器
负责转发双方的媒体信息（SDP）和网络信息（Candidate），还有房间管理、用户列表、用户进入、用户退出等IM功能


### 2.3 连接建立的流程

1. 连接双方通过第三方服务器来交换各自的SDP数据
2. 连接双方通过STUN协议从STUN服务器那里获取到自己的NAT结构、子网IP和公网IP、端口，即Candidate信息
3. 连接双方通过第三方服务器来交换各自的Candidate信息，如果在同一个NAT下，那么通过内网Candidate就能建立连接；如果不同NAT下，则通过STUN服务器识别出的公网Candidate进行通信
4. 如果通过STUN服务器仍然无法建立连接，则寻求TURN服务器提供转发服务，然后将转发形式的Candidate共享给对方
5. 连接双方向目标IP端口发送报文，通过SDP数据重涉及的密钥以及期望传输的内容建立起加密长链接
